<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Peta Risiko Banjir Kabupaten Solok Selatan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* (styles Anda tetap sama seperti yang Anda berikan) */
        /* ... semua CSS yang Anda kirim tetap sama ... */
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> Peta Risiko Banjir Kabupaten Solok Selatan</h1>
        <p>Peta Interaktif Risiko Banjir untuk Masyarakat Solok Selatan</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cari lokasi (nama desa, jalan, dll)" />
            </div>

            <div class="alert">
                <i class="fas fa-exclamation-triangle"></i>
                Peta ini untuk edukasi dan kewaspadaan masyarakat
            </div>

            <div class="legend">
                <h3><i class="fas fa-water"></i> Risiko Banjir (HAND 30m)</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d32f2f;"></div>
                    <span><strong>Risiko Tinggi</strong> (High Flood Risk)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span><strong>Risiko Sedang</strong> (Medium Flood Risk)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span><strong>Risiko Rendah</strong> (Low Flood Risk)</span>
                </div>
            </div>

            <div class="controls">
                <h3><i class="fas fa-layers"></i> Layer Control</h3>
                <button class="toggle-btn active" id="floodToggle">
                    <i class="fas fa-water"></i> Tampilkan Risiko Banjir
                </button>
                <button class="toggle-btn" id="satelliteToggle">
                    <i class="fas fa-satellite"></i> View Satelit
                </button>
            </div>

            <div class="info-panel">
                <h4><i class="fas fa-info-circle"></i> Cara Menggunakan</h4>
                <p>• Klik pada peta untuk melihat detail risiko lokasi<br />
                    • Gunakan tombol layer untuk show/hide data<br />
                    • Zoom in/out untuk melihat detail area<br />
                    • Cari lokasi spesifik dengan search box
                </p>
            </div>

            <div class="info-panel">
                <h4><i class="fas fa-exclamation-triangle"></i> Peringatan</h4>
                <p>Peta ini berdasarkan data satelit dan analisis topografi. Untuk keputusan penting, konsultasikan dengan BPBD setempat.</p>
            </div>

            <div class="info-panel">
                <h4><i class="fas fa-heart"></i> Dibuat untuk Masyarakat</h4>
                <p>Peta ini dibuat secara independen untuk meningkatkan kesadaran masyarakat tentang risiko bencana di Solok Selatan.</p>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Memuat data...</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Initialize map centered on Solok Selatan
        const map = L.map('map').setView([-1.2379, 101.3158], 10);

        // Base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
        });

        const satelliteLayer = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            {
                attribution:
                    '© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
            }
        );

        osmLayer.addTo(map);

        // Layer groups for flood risk data
        let floodLayers = L.layerGroup();
        floodLayers.addTo(map);

        // ========================================================================
        // GEOJSON RISIKO BANJIR (CONTOH)
        // Ganti data ini dengan GeoJSON asli Anda dari repo GitHub
        // ========================================================================

        const highFloodRiskData = {
            type: "FeatureCollection",
            features: [
                {
                    type: "Feature",
                    properties: {
                        risk_level: "high",
                        description: "Area dengan risiko banjir tinggi",
                    },
                    geometry: {
                        type: "Polygon",
                        coordinates: [
                            [
                                [101.3000, -1.2300],
                                [101.3100, -1.2300],
                                [101.3100, -1.2400],
                                [101.3000, -1.2400],
                                [101.3000, -1.2300],
                            ],
                        ],
                    },
                },
            ],
        };

        const mediumFloodRiskData = {
            type: "FeatureCollection",
            features: [
                {
                    type: "Feature",
                    properties: {
                        risk_level: "medium",
                        description: "Area dengan risiko banjir sedang",
                    },
                    geometry: {
                        type: "Polygon",
                        coordinates: [
                            [
                                [101.3200, -1.2500],
                                [101.3300, -1.2500],
                                [101.3300, -1.2600],
                                [101.3200, -1.2600],
                                [101.3200, -1.2500],
                            ],
                        ],
                    },
                },
            ],
        };

        const lowFloodRiskData = {
            type: "FeatureCollection",
            features: [
                {
                    type: "Feature",
                    properties: {
                        risk_level: "low",
                        description: "Area dengan risiko banjir rendah",
                    },
                    geometry: {
                        type: "Polygon",
                        coordinates: [
                            [
                                [101.3400, -1.2700],
                                [101.3500, -1.2700],
                                [101.3500, -1.2800],
                                [101.3400, -1.2800],
                                [101.3400, -1.2700],
                            ],
                        ],
                    },
                },
            ],
        };

        // ========================================================================
        // STYLE DAN FUNGSI UNTUK MEMBUAT POPUP
        // ========================================================================

        function getFloodStyle(feature) {
            const riskLevel = feature.properties.risk_level;
            const colors = {
                high: "#d32f2f",
                medium: "#ff9800",
                low: "#4caf50",
            };

            return {
                fillColor: colors[riskLevel] || "gray",
                weight: 2,
                opacity: 0.8,
                color: "white",
                fillOpacity: 0.7,
            };
        }

        function createPopupContent(feature) {
            const props = feature.properties;
            const riskLevel = props.risk_level;
            const riskText =
                riskLevel === "high"
                    ? "TINGGI"
                    : riskLevel === "medium"
                    ? "SEDANG"
                    : "RENDAH";
            const riskColor =
                riskLevel === "high"
                    ? "#d32f2f"
                    : riskLevel === "medium"
                    ? "#ff9800"
                    : "#4caf50";

            return `
                <div style="font-family: Arial, sans-serif; min-width: 200px;">
                    <h4 style="color: ${riskColor}; margin: 0 0 10px 0;">
                        <i class="fas fa-water"></i> Risiko Banjir
                    </h4>
                    <p><strong>Level Risiko:</strong> ${riskText}</p>
                    <p><strong>Keterangan:</strong> ${
                        props.description || "Area dengan risiko banjir " + riskText.toLowerCase()
                    }</p>
                    ${
                        props.hand_value
                            ? `<p><strong>HAND Value:</strong> ${props.hand_value}m</p>`
                            : ""
                    }
                    ${
                        props.additional_info
                            ? `<p><strong>Info Tambahan:</strong> ${props.additional_info}</p>`
                            : ""
                    }
                </div>
            `;
        }

        function addFloodData(geojsonData) {
            const layer = L.geoJSON(geojsonData, {
                style: getFloodStyle,
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(createPopupContent(feature));
                },
            });

            floodLayers.addLayer(layer);
        }

        function loadFloodData() {
            addFloodData(highFloodRiskData);
            addFloodData(mediumFloodRiskData);
            addFloodData(lowFloodRiskData);
        }

        loadFloodData();

        // Layer toggle controls
        document.getElementById("floodToggle").addEventListener("click", function () {
            if (map.hasLayer(floodLayers)) {
                map.removeLayer(floodLayers);
                this.classList.remove("active");
                this.innerHTML = '<i class="fas fa-water"></i> Tampilkan Risiko Banjir';
            } else {
                map.addLayer(floodLayers);
                this.classList.add("active");
                this.innerHTML = '<i class="fas fa-water"></i> Sembunyikan Risiko Banjir';
            }
        });

        document.getElementById("satelliteToggle").addEventListener("click", function () {
            if (map.hasLayer(satelliteLayer)) {
                map.removeLayer(satelliteLayer);
                osmLayer.addTo(map);
                this.classList.remove("active");
                this.innerHTML = '<i class="fas fa-satellite"></i> View Satelit';
            } else {
                map.removeLayer(osmLayer);
                satelliteLayer.addTo(map);
                this.classList.add("active");
                this.innerHTML = '<i class="fas fa-satellite"></i> View Peta Biasa';
            }
        });

        // Loading spinner (dummy example)
        const loading = document.getElementById("loading");
        map.on("loading", () => {
            loading.style.display = "flex";
        });
        map.on("load", () => {
            loading.style.display = "none";
        });

        // Search functionality (very basic - hanya filter nama fitur, perlu API lebih lengkap utk data desa jalan)
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function () {
            const query = this.value.trim().toLowerCase();

            // Jika kosong, tampilkan semua layer
            if (!query) {
                floodLayers.clearLayers();
                loadFloodData();
                return;
            }

            // Filter fitur berdasarkan properti description yang mengandung query
            const filteredHigh = {
                type: "FeatureCollection",
                features: highFloodRiskData.features.filter((f) =>
                    (f.properties.description || "").toLowerCase().includes(query)
                ),
            };

            const filteredMedium = {
                type: "FeatureCollection",
                features: mediumFloodRiskData.features.filter((f) =>
                    (f.properties.description || "").toLowerCase().includes(query)
                ),
            };

            const filteredLow = {
                type: "FeatureCollection",
                features: lowFloodRiskData.features.filter((f) =>
                    (f.properties.description || "").toLowerCase().includes(query)
                ),
            };

            floodLayers.clearLayers();
            addFloodData(filteredHigh);
            addFloodData(filteredMedium);
            addFloodData(filteredLow);
        });
    </script>
</body>
</html>
